name: ğŸ–¥ï¸ Build ChromeOS Compatible Keyboard

permissions:
  contents: write
  packages: write

on:
  push:
    branches: 
      - feature/chromeos-support
      - main
    paths:
      - 'android_keyboard/**'
      - '.github/workflows/**'
    tags:
      - 'v*-chromeos'
  pull_request:
    branches: [ main ]
    paths:
      - 'android_keyboard/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Type de build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - apk-only
          - aab-only

jobs:
  # ğŸ–¥ï¸ Ã‰TAPE 1 : VÃ‰RIFICATION COMPATIBILITÃ‰ CHROMEOS
  verify-chromeos-config:
    name: ğŸ” Verify ChromeOS Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Verify AndroidManifest ChromeOS Features
      run: |
        echo "ğŸ” VÃ©rification configuration ChromeOS..."
        
        MANIFEST="android_keyboard/app/src/main/AndroidManifest.xml"
        
        # VÃ©rifier les fonctionnalitÃ©s optionnelles
        if grep -q 'android.hardware.type.pc' "$MANIFEST"; then
          echo "âœ… ChromeOS type.pc feature dÃ©clarÃ©"
        else
          echo "âŒ ERREUR: android.hardware.type.pc manquant"
          exit 1
        fi
        
        # VÃ©rifier resizable activity
        if grep -q 'resizeableActivity.*true' "$MANIFEST"; then
          echo "âœ… resizeableActivity activÃ©"
        else
          echo "âš ï¸ WARNING: resizeableActivity pas explicitement activÃ©"
        fi
        
        # VÃ©rifier multi-window
        if grep -q 'allow_multiple_resumed_activities' "$MANIFEST"; then
          echo "âœ… Multi-window support activÃ©"
        else
          echo "âš ï¸ WARNING: Multi-window support manquant"
        fi
        
        echo ""
        echo "ğŸ“Š RÃ‰SUMÃ‰ CONFIGURATION CHROMEOS:"
        echo "================================"
        grep -E '(type.pc|resizeableActivity|allow_multiple_resumed_activities|max_aspect)' "$MANIFEST" || echo "Configuration Ã  vÃ©rifier"

    - name: ğŸ” Verify build.gradle ChromeOS Architectures
      run: |
        echo "ğŸ” VÃ©rification architectures x86/x86_64..."
        
        BUILD_GRADLE="android_keyboard/app/build.gradle"
        
        # VÃ©rifier x86 et x86_64
        if grep -q "x86" "$BUILD_GRADLE" && grep -q "x86_64" "$BUILD_GRADLE"; then
          echo "âœ… Architectures x86/x86_64 configurÃ©es"
          echo ""
          echo "ğŸ“Š Configuration NDK:"
          grep -A 3 "abiFilters" "$BUILD_GRADLE" || echo "abiFilters non trouvÃ©"
        else
          echo "âŒ ERREUR: Architectures x86/x86_64 manquantes"
          echo "Configuration actuelle:"
          grep -A 3 "ndk" "$BUILD_GRADLE" || echo "Section ndk non trouvÃ©e"
          exit 1
        fi
        
        echo ""
        echo "âœ… Configuration ChromeOS validÃ©e!"

  # ğŸ”§ Ã‰TAPE 2A : BUILD DEBUG APK (avec x86/x86_64)
  build-chromeos-debug-apk:
    name: ğŸ”§ Build ChromeOS Debug APK
    runs-on: ubuntu-latest
    needs: verify-chromeos-config
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: ğŸ§¹ Clean Project
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle clean --no-daemon --scan

    - name: ğŸ”¨ Build ChromeOS Debug APK (4 architectures)
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: |
        cd android_keyboard
        echo "ğŸ—ï¸ Building APK avec support ChromeOS..."
        echo "ğŸ“± Architectures: armeabi-v7a, arm64-v8a, x86, x86_64"
        gradle assembleDebug --no-daemon --scan
        
        echo ""
        echo "ğŸ“Š APK gÃ©nÃ©rÃ©:"
        ls -lh app/build/outputs/apk/debug/*.apk

    - name: ğŸ” Verify APK Architectures
      run: |
        cd android_keyboard
        APK_FILE=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
        
        echo "ğŸ” VÃ©rification des architectures dans l'APK..."
        echo "ğŸ“¦ APK: $(basename $APK_FILE)"
        echo ""
        
        # Extraire et vÃ©rifier les librairies natives
        unzip -l "$APK_FILE" | grep "lib/" | grep ".so" | awk '{print $4}' | cut -d'/' -f1-2 | sort -u
        
        echo ""
        ARCH_COUNT=$(unzip -l "$APK_FILE" | grep "lib/" | cut -d'/' -f2 | sort -u | wc -l)
        echo "ğŸ“Š Nombre d'architectures dÃ©tectÃ©es: $ARCH_COUNT"
        
        if [ "$ARCH_COUNT" -ge 4 ]; then
          echo "âœ… APK contient les 4 architectures (ARM + x86 pour ChromeOS)"
        else
          echo "âš ï¸ WARNING: APK contient seulement $ARCH_COUNT architectures"
        fi

    - name: ğŸ“¤ Upload ChromeOS Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: chromeos-keyboard-debug-apk
        path: android_keyboard/app/build/outputs/apk/debug/*.apk
        retention-days: 7

  # ğŸ“¦ Ã‰TAPE 2B : BUILD DEBUG AAB
  build-chromeos-debug-aab:
    name: ğŸ“¦ Build ChromeOS Debug AAB
    runs-on: ubuntu-latest
    needs: verify-chromeos-config
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'aab-only'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: ğŸ“¦ Build ChromeOS Debug AAB
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle bundleDebug --no-daemon --scan

    - name: ğŸ“¤ Upload ChromeOS Debug AAB
      uses: actions/upload-artifact@v4
      with:
        name: chromeos-keyboard-debug-aab
        path: android_keyboard/app/build/outputs/bundle/debug/*.aab
        retention-days: 7

  # ğŸš€ Ã‰TAPE 3A : BUILD RELEASE APK
  build-chromeos-release-apk:
    name: ğŸš€ Build ChromeOS Release APK
    runs-on: ubuntu-latest
    needs: verify-chromeos-config
    
    env:
      KEYSTORE_FILE: potomitan-keystore.jks
      STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: ğŸ” Setup Production Keystore
      run: |
        cd android_keyboard
        
        if [ -n "$STORE_PASSWORD" ] && [ -n "$KEY_ALIAS" ] && [ -n "$KEY_PASSWORD" ]; then
          echo "ğŸ”‘ Creating production keystore for ChromeOS release..."
          keytool -genkey -v -keystore app/$KEYSTORE_FILE -alias "$KEY_ALIAS" -keyalg RSA -keysize 2048 -validity 25000 \
            -storepass "$STORE_PASSWORD" -keypass "$KEY_PASSWORD" \
            -dname "CN=Potomitan Kreyol Keyboard,OU=Potomitan,O=Famibelle,L=Guadeloupe,ST=Guadeloupe,C=GP"
          echo "âœ… Production keystore created"
        else
          echo "âš ï¸ Production secrets not available, using debug signing..."
        fi

    - name: ğŸ§¹ Clean Project
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle clean --no-daemon --scan

    - name: ğŸš€ Build ChromeOS Release APK
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: |
        cd android_keyboard
        echo "ğŸ—ï¸ Building Release APK avec support ChromeOS..."
        echo "ğŸ“± Architectures: armeabi-v7a, arm64-v8a, x86, x86_64"
        gradle assembleRelease --no-daemon --scan
        
        echo ""
        echo "ğŸ“Š Release APK gÃ©nÃ©rÃ©:"
        ls -lh app/build/outputs/apk/release/*.apk

    - name: ğŸ” Verify Release APK Architectures
      run: |
        cd android_keyboard
        APK_FILE=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
        
        echo "ğŸ” VÃ©rification architectures Release APK..."
        unzip -l "$APK_FILE" | grep "lib/" | grep ".so" | awk '{print $4}' | cut -d'/' -f1-2 | sort -u
        
        ARCH_COUNT=$(unzip -l "$APK_FILE" | grep "lib/" | cut -d'/' -f2 | sort -u | wc -l)
        echo "ğŸ“Š Architectures: $ARCH_COUNT"
        
        if [ "$ARCH_COUNT" -ge 4 ]; then
          echo "âœ… Release APK prÃªt pour ChromeOS et Android"
        fi

    - name: ğŸ“¤ Upload ChromeOS Release APK
      uses: actions/upload-artifact@v4
      with:
        name: chromeos-keyboard-release-apk
        path: android_keyboard/app/build/outputs/apk/release/*.apk
        retention-days: 30

  # ğŸ¯ Ã‰TAPE 3B : BUILD RELEASE AAB
  build-chromeos-release-aab:
    name: ğŸ¯ Build ChromeOS Release AAB
    runs-on: ubuntu-latest
    needs: verify-chromeos-config
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'aab-only'
    
    env:
      KEYSTORE_FILE: potomitan-keystore.jks
      STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: ğŸ” Setup Production Keystore
      run: |
        cd android_keyboard
        
        if [ -n "$STORE_PASSWORD" ] && [ -n "$KEY_ALIAS" ] && [ -n "$KEY_PASSWORD" ]; then
          echo "ğŸ”‘ Creating production keystore for ChromeOS AAB..."
          keytool -genkey -v -keystore app/$KEYSTORE_FILE -alias "$KEY_ALIAS" -keyalg RSA -keysize 2048 -validity 25000 \
            -storepass "$STORE_PASSWORD" -keypass "$KEY_PASSWORD" \
            -dname "CN=Potomitan Kreyol Keyboard,OU=Potomitan,O=Famibelle,L=Guadeloupe,ST=Guadeloupe,C=GP"
          echo "âœ… Production keystore for AAB created"
        fi

    - name: ğŸ¯ Build ChromeOS Release AAB
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: |
        cd android_keyboard
        echo "ğŸ—ï¸ Building Release AAB pour Play Store (Android + ChromeOS)..."
        gradle bundleRelease --no-daemon --scan
        
        echo ""
        echo "ğŸ“Š Release AAB gÃ©nÃ©rÃ©:"
        ls -lh app/build/outputs/bundle/release/*.aab

    - name: ğŸ“¤ Upload ChromeOS Release AAB
      uses: actions/upload-artifact@v4
      with:
        name: chromeos-keyboard-release-aab
        path: android_keyboard/app/build/outputs/bundle/release/*.aab
        retention-days: 30

  # ğŸ“Š Ã‰TAPE 4 : VALIDATION & RAPPORT
  validate-chromeos-builds:
    name: ğŸ” Validate ChromeOS Builds
    runs-on: ubuntu-latest
    needs: [build-chromeos-debug-apk, build-chromeos-release-apk]
    
    steps:
    - name: ğŸ“¥ Download Debug APK
      uses: actions/download-artifact@v4
      with:
        name: chromeos-keyboard-debug-apk
        path: ./debug-apk

    - name: ğŸ“¥ Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: chromeos-keyboard-release-apk
        path: ./release-apk

    - name: ğŸ“Š ChromeOS Build Summary
      run: |
        echo "ğŸ–¥ï¸ CHROMEOS BUILD VALIDATION"
        echo "============================"
        echo ""
        
        echo "ğŸ”§ DEBUG APK:"
        DEBUG_APK=$(find ./debug-apk -name "*.apk" | head -1)
        if [ -f "$DEBUG_APK" ]; then
          DEBUG_SIZE=$(stat -c%s "$DEBUG_APK" 2>/dev/null || stat -f%z "$DEBUG_APK" 2>/dev/null)
          DEBUG_SIZE_MB=$(echo "scale=2; $DEBUG_SIZE / 1048576" | bc)
          echo "  ğŸ“± Fichier: $(basename $DEBUG_APK)"
          echo "  ğŸ“Š Taille: ${DEBUG_SIZE_MB} MB"
          
          echo "  ğŸ” Architectures:"
          unzip -l "$DEBUG_APK" | grep "lib/" | cut -d'/' -f2 | sort -u | while read arch; do
            echo "     âœ… $arch"
          done
        fi
        
        echo ""
        echo "ğŸš€ RELEASE APK:"
        RELEASE_APK=$(find ./release-apk -name "*.apk" | head -1)
        if [ -f "$RELEASE_APK" ]; then
          RELEASE_SIZE=$(stat -c%s "$RELEASE_APK" 2>/dev/null || stat -f%z "$RELEASE_APK" 2>/dev/null)
          RELEASE_SIZE_MB=$(echo "scale=2; $RELEASE_SIZE / 1048576" | bc)
          echo "  ğŸ“± Fichier: $(basename $RELEASE_APK)"
          echo "  ğŸ“Š Taille: ${RELEASE_SIZE_MB} MB"
          
          echo "  ğŸ” Architectures:"
          unzip -l "$RELEASE_APK" | grep "lib/" | cut -d'/' -f2 | sort -u | while read arch; do
            echo "     âœ… $arch"
          done
        fi
        
        echo ""
        echo "âœ… CHROMEOS COMPATIBILITY VALIDATED!"
        echo "   - Android ARM devices âœ…"
        echo "   - ChromeOS Intel/AMD (x86/x86_64) âœ…"
        echo "   - ChromeOS ARM devices âœ…"

    - name: âœ… Mark ChromeOS Builds Valid
      run: echo "âœ… All ChromeOS builds completed successfully!"

  # ğŸ‰ Ã‰TAPE 5 : CRÃ‰ATION RELEASE CHROMEOS (si tag)
  create-chromeos-release:
    name: ğŸ‰ Create ChromeOS Release
    runs-on: ubuntu-latest
    needs: [validate-chromeos-builds]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ Download All ChromeOS Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: chromeos-keyboard-*
        path: ./all-chromeos-artifacts

    - name: ğŸ“ Prepare ChromeOS Release Assets
      run: |
        echo "ğŸ“ PrÃ©paration assets ChromeOS..."
        mkdir -p ./final-chromeos-assets
        
        # APK Release
        RELEASE_APK=$(find ./all-chromeos-artifacts/chromeos-keyboard-release-apk -name "*.apk" | head -1)
        if [ -n "$RELEASE_APK" ] && [ -f "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" "./final-chromeos-assets/KreyolKeyboard-ChromeOS-Release-${{ github.ref_name }}.apk"
          echo "âœ… APK Release ChromeOS"
        fi
        
        # APK Debug
        DEBUG_APK=$(find ./all-chromeos-artifacts/chromeos-keyboard-debug-apk -name "*.apk" | head -1)
        if [ -n "$DEBUG_APK" ] && [ -f "$DEBUG_APK" ]; then
          cp "$DEBUG_APK" "./final-chromeos-assets/KreyolKeyboard-ChromeOS-Debug-${{ github.ref_name }}.apk"
          echo "âœ… APK Debug ChromeOS"
        fi
        
        # AAB Release (si disponible)
        RELEASE_AAB=$(find ./all-chromeos-artifacts/chromeos-keyboard-release-aab -name "*.aab" 2>/dev/null | head -1)
        if [ -n "$RELEASE_AAB" ] && [ -f "$RELEASE_AAB" ]; then
          cp "$RELEASE_AAB" "./final-chromeos-assets/KreyolKeyboard-ChromeOS-Release-${{ github.ref_name }}.aab"
          echo "âœ… AAB Release ChromeOS"
        fi
        
        echo ""
        echo "ğŸ“Š ASSETS CHROMEOS:"
        ls -lh ./final-chromeos-assets/

    - name: ğŸ‰ Create GitHub ChromeOS Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: ğŸ–¥ï¸ KlavyÃ© KreyÃ²l ChromeOS ${{ github.ref_name }}
        body: |
          ğŸ–¥ï¸ **Clavier KreyÃ²l - ChromeOS Compatible Release ${{ github.ref_name }}**
          
          ## ğŸ¯ COMPATIBILITÃ‰ CHROMEOS
          
          Cette version est **100% compatible ChromeOS** avec support complet de :
          - âœ… **Chromebooks Intel/AMD** (x86, x86_64)
          - âœ… **Chromebooks ARM** (armeabi-v7a, arm64-v8a)
          - âœ… **Mode multi-fenÃªtres** ChromeOS
          - âœ… **Redimensionnement** de fenÃªtre
          - âœ… **Ã‰crans larges** (ratio 2.4:1)
          - âœ… **TÃ©lÃ©phones et tablettes Android** (zÃ©ro rÃ©gression)
          
          ## ğŸ“± FICHIERS DISPONIBLES
          
          - ğŸ–¥ï¸ **APK Release ChromeOS** - Installation directe (Chromebook + Android)
          - ğŸ”§ **APK Debug ChromeOS** - Version dÃ©veloppement
          - ğŸª **AAB Release** - Bundle Google Play Store (si disponible)
          
          ## ğŸ”§ ARCHITECTURES INCLUSES
          
          Chaque APK contient **4 architectures** :
          1. `armeabi-v7a` - ARM 32-bit (anciens appareils)
          2. `arm64-v8a` - ARM 64-bit (appareils rÃ©cents)
          3. `x86` - Intel 32-bit (Chromebooks Intel anciens)
          4. `x86_64` - Intel 64-bit (Chromebooks modernes)
          
          ## ğŸ“Š TAILLE APK
          
          - **Debug** : ~5.5 MB (4 architectures)
          - **Release** : ~3 MB (optimisÃ© et minifiÃ©)
          - **Via Play Store** : Distribution dynamique (taille optimale par appareil)
          
          ## ğŸš€ INSTALLATION CHROMEBOOK
          
          ### Via Play Store (RecommandÃ©)
          1. Ouvrir le Play Store sur votre Chromebook
          2. Rechercher "KlavyÃ© KreyÃ²l" ou "Potomitan Keyboard"
          3. Installer
          
          ### Via APK (DÃ©veloppeurs)
          ```bash
          adb install KreyolKeyboard-ChromeOS-Release-*.apk
          ```
          
          ### Activation
          1. **ParamÃ¨tres** â†’ **Langues et saisie**
          2. **MÃ©thodes de saisie** â†’ Activer "KlavyÃ© KreyÃ²l"
          3. Utiliser **Ctrl + Espace** pour basculer
          
          ## ğŸ“š DOCUMENTATION
          
          - ğŸ“˜ [CHROMEOS_COMPATIBILITY.md](https://github.com/famibelle/KreyolKeyb/blob/feature/chromeos-support/android_keyboard/CHROMEOS_COMPATIBILITY.md)
          - ğŸ“— [GUIDE_TEST_CHROMEOS.md](https://github.com/famibelle/KreyolKeyb/blob/feature/chromeos-support/android_keyboard/GUIDE_TEST_CHROMEOS.md)
          - ğŸ“™ [CHROMEOS_CHANGES.md](https://github.com/famibelle/KreyolKeyb/blob/feature/chromeos-support/android_keyboard/CHROMEOS_CHANGES.md)
          
          ## ğŸ‰ NOUVEAUTÃ‰S CHROMEOS
          
          - âœ… Support complet processeurs Intel/AMD
          - âœ… Optimisation pour Ã©crans larges
          - âœ… Multi-fenÃªtres natif
          - âœ… Redimensionnement fluide
          - âœ… Performance identique Ã  Android
          
          ---
          
          ğŸ‡­ğŸ‡¹ **KreyÃ²l kounye a disponib sou Chromebook!** ğŸ–¥ï¸
          
          **MÃ¨si anpil pou sipÃ² w!**
        draft: false
        prerelease: false
        make_latest: true
        files: ./final-chromeos-assets/*
