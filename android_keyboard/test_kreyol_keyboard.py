#!/usr/bin/env python3
"""
Script de test automatis√© pour le clavier cr√©ole Krey√≤l Karukera
Tests de validation pour l'architecture refactoris√©e
"""

import subprocess
import time
import sys
import re

class KreyolKeyboardTester:
    def __init__(self):
        self.test_results = []
        self.adb_prefix = ["adb", "shell"]
    
    def run_adb_command(self, command):
        """Ex√©cute une commande ADB et retourne le r√©sultat"""
        try:
            result = subprocess.run(
                self.adb_prefix + command, 
                capture_output=True, 
                text=True, 
                timeout=10
            )
            return result.stdout.strip(), result.returncode == 0
        except subprocess.TimeoutExpired:
            return "Timeout", False
        except Exception as e:
            return str(e), False
    
    def log_test(self, test_name, success, details=""):
        """Enregistre le r√©sultat d'un test"""
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        self.test_results.append({
            'name': test_name,
            'status': status,
            'success': success,
            'details': details
        })
        print(f"{status} - {test_name}")
        if details:
            print(f"    {details}")
    
    def test_service_installation(self):
        """Test 1: V√©rifier que le service est install√©"""
        print("\nüîç Test 1: Installation du service")
        
        # V√©rifier que l'APK est install√©
        output, success = self.run_adb_command([
            "pm", "list", "packages", "com.potomitan.kreyolkeyboard"
        ])
        
        if success and "com.potomitan.kreyolkeyboard" in output:
            self.log_test(
                "Installation APK", 
                True, 
                "Package trouv√© dans le syst√®me"
            )
        else:
            self.log_test(
                "Installation APK", 
                False, 
                "Package non trouv√©"
            )
            return False
        
        # V√©rifier que le service IME est d√©clar√©
        output, success = self.run_adb_command([
            "pm", "dump", "com.potomitan.kreyolkeyboard", "|", "grep", "InputMethod"
        ])
        
        self.log_test(
            "Service IME d√©clar√©", 
            success and "InputMethod" in output,
            "Service trouv√© dans le manifeste" if success else "Service non trouv√©"
        )
        
        return True
    
    def test_service_activation(self):
        """Test 2: Tenter d'activer le service"""
        print("\n‚ö° Test 2: Activation du service")
        
        # Lister les IME disponibles
        output, success = self.run_adb_command([
            "ime", "list", "-a"
        ])
        
        kreyol_ime_found = "kreyolkeyboard" in output.lower()
        self.log_test(
            "IME disponible dans la liste", 
            kreyol_ime_found,
            "Trouv√© dans ime list" if kreyol_ime_found else "Non trouv√© dans ime list"
        )
        
        if kreyol_ime_found:
            # Essayer d'activer le clavier (n√©cessite interaction utilisateur)
            print("üì± Action requise: Activez manuellement le clavier dans les param√®tres")
            self.log_test(
                "Activation manuelle requise", 
                True,
                "Allez dans Param√®tres > Langue et saisie > Clavier virtuel"
            )
        
        return kreyol_ime_found
    
    def test_logcat_monitoring(self):
        """Test 3: Surveiller les logs pour d√©tecter le d√©marrage"""
        print("\nüìä Test 3: Surveillance des logs")
        
        try:
            # Nettoyer les logs et surveiller
            subprocess.run(["adb", "logcat", "-c"], check=True)
            
            print("üîç Surveillance des logs (dur√©e: 10 secondes)...")
            print("üí° Essayez d'ouvrir une app avec saisie de texte maintenant")
            
            # Surveiller les logs pendant 10 secondes
            result = subprocess.run([
                "adb", "logcat", "-t", "10"
            ], capture_output=True, text=True, timeout=10)
            
            logs = result.stdout
            
            # Chercher les logs du service Kreyol
            kreyol_logs = []
            for line in logs.split('\n'):
                if any(keyword in line.lower() for keyword in ['kreyol', 'potomitan', 'ime']):
                    kreyol_logs.append(line.strip())
            
            if kreyol_logs:
                self.log_test(
                    "Logs du service d√©tect√©s", 
                    True,
                    f"{len(kreyol_logs)} entr√©es trouv√©es"
                )
                print("üìù Logs pertinents:")
                for log in kreyol_logs[:5]:  # Afficher les 5 premiers
                    print(f"    {log}")
            else:
                self.log_test(
                    "Logs du service d√©tect√©s", 
                    False,
                    "Aucun log Kreyol trouv√© - le service n'est peut-√™tre pas actif"
                )
            
        except subprocess.TimeoutExpired:
            self.log_test("Surveillance logs", False, "Timeout lors de la surveillance")
        except Exception as e:
            self.log_test("Surveillance logs", False, f"Erreur: {str(e)}")
    
    def test_basic_functionality(self):
        """Test 4: Tests fonctionnels de base"""
        print("\n‚å®Ô∏è Test 4: Fonctionnalit√©s de base")
        
        print("üì± Tests manuels requis:")
        print("1. Ouvrez une application de saisie (Messages, Notes, etc.)")
        print("2. S√©lectionnez le clavier Krey√≤l Karukera")
        print("3. Testez les fonctionnalit√©s suivantes:")
        
        manual_tests = [
            "Saisie de lettres normales (a, b, c...)",
            "Basculer majuscules/minuscules avec ‚áß",
            "Passer en mode num√©rique avec 123",
            "Appui long sur 'a' pour obtenir '√†'", 
            "Appui long sur 'e' pour obtenir '√©'",
            "Utilisation des suggestions de mots",
            "Touches sp√©ciales: espace, retour, suppression"
        ]
        
        for i, test in enumerate(manual_tests, 1):
            print(f"   {i}. {test}")
        
        # Test automatique: v√©rifier les processus actifs
        output, success = self.run_adb_command([
            "ps", "|", "grep", "kreyol"
        ])
        
        if success and "kreyol" in output.lower():
            self.log_test(
                "Processus service actif", 
                True,
                "Service trouv√© dans les processus"
            )
        else:
            self.log_test(
                "Processus service actif", 
                False,
                "Service non trouv√© dans les processus actifs"
            )
    
    def test_performance_monitoring(self):
        """Test 5: Surveillance des performances"""
        print("\nüìà Test 5: Performance et m√©moire")
        
        # V√©rifier l'utilisation m√©moire
        output, success = self.run_adb_command([
            "dumpsys", "meminfo", "com.potomitan.kreyolkeyboard"
        ])
        
        if success and "TOTAL" in output:
            # Extraire les informations m√©moire
            lines = output.split('\n')
            memory_info = [line for line in lines if 'TOTAL' in line or 'Native Heap' in line]
            
            self.log_test(
                "Informations m√©moire disponibles", 
                True,
                f"Donn√©es collect√©es: {len(memory_info)} m√©triques"
            )
            
            for info in memory_info[:3]:  # Afficher les 3 premi√®res m√©triques
                print(f"    üìä {info.strip()}")
                
        else:
            self.log_test(
                "Informations m√©moire", 
                False,
                "Impossible de r√©cup√©rer les donn√©es m√©moire"
            )
    
    def generate_report(self):
        """G√©n√®re un rapport final des tests"""
        print("\n" + "="*60)
        print("üéØ RAPPORT FINAL DES TESTS")
        print("="*60)
        
        total_tests = len(self.test_results)
        passed_tests = sum(1 for result in self.test_results if result['success'])
        failed_tests = total_tests - passed_tests
        
        print(f"üìä Total des tests: {total_tests}")
        print(f"‚úÖ Tests r√©ussis: {passed_tests}")
        print(f"‚ùå Tests √©chou√©s: {failed_tests}")
        print(f"üìà Taux de r√©ussite: {(passed_tests/total_tests)*100:.1f}%")
        
        print("\nüìã D√©tail des r√©sultats:")
        for result in self.test_results:
            print(f"  {result['status']} {result['name']}")
            if result['details']:
                print(f"      ‚Üí {result['details']}")
        
        if failed_tests == 0:
            print("\nüéâ TOUS LES TESTS AUTOMATIQUES SONT PASS√âS!")
            print("üí° N'oubliez pas de tester manuellement les fonctionnalit√©s du clavier")
        else:
            print(f"\n‚ö†Ô∏è  {failed_tests} test(s) ont √©chou√©. V√©rifiez l'installation et l'activation.")
        
        print("\nüîß Prochaines √©tapes recommand√©es:")
        print("1. Activer le clavier dans Param√®tres Android")
        print("2. Tester manuellement toutes les fonctionnalit√©s")
        print("3. V√©rifier les suggestions de mots cr√©oles")
        print("4. Valider les accents et caract√®res sp√©ciaux")
        
    def run_all_tests(self):
        """Lance tous les tests"""
        print("üöÄ D√âBUT DES TESTS DU CLAVIER KREY√íL KARUKERA")
        print("Version: Architecture refactoris√©e v3.0.0")
        print("Date: 11 septembre 2025\n")
        
        try:
            self.test_service_installation()
            self.test_service_activation()
            self.test_logcat_monitoring()
            self.test_basic_functionality()
            self.test_performance_monitoring()
            
        except KeyboardInterrupt:
            print("\n‚èπÔ∏è Tests interrompus par l'utilisateur")
        except Exception as e:
            print(f"\n‚ùå Erreur lors des tests: {str(e)}")
        
        finally:
            self.generate_report()

if __name__ == "__main__":
    tester = KreyolKeyboardTester()
    tester.run_all_tests()
